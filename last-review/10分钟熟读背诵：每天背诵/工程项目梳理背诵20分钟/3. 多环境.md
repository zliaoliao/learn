

- 背景与痛点： 
  - 起念： 
    - 需要建立一个新的子应用，需要申请域名，申请测试机，配置测试机参数；还要搞几套；一个子应用整个测试环境搞下来，得一天时间，十分繁琐; 
    - 我就觉得这个有必要优化一下，大概想了一下这个方案，如果做要怎么做，但是新建子应用的场景，比较不是很多，做出来性价比当时也不是很高，我就没找领导提这个事；
  - 提出方案的契机：
    - 有一阵子，并行项目比较多，测试同学找到我说，测过的功能全乱了，我一查是代码被覆盖了，而且那几天频繁出现业务覆盖的问题，测试同学都有些抱怨了。
    - 我就觉得这个我的方案应该能解决：新建测试环境，测试环境代码覆盖这两个问题；这样一看，还是挺有价值的，就找领导提一下这个事，领导让让我出个方案，大家过一下；
  - 方案思路了：
    - 核心：
      - 路径隔离：所谓部署测试环境，就是讨论一个怎么把测试代码部署到测试机上的问题，不同的测试环境，主要是要隔离和区分。之前用域名和机器隔离，那么是不是可以用一个域名指向多个机器能，省略掉申请域名这一步，更进一步，是不是连申请机器这一步也省略掉呢，就在一个机器上，用路径去做环境隔离
      - 我的核心思路很简单，就是用路径去区分环境，前端部署到对应路径上，测试的时候根据环境区去拉去对应资源。
  - 有了核心思路，就可以梳理流程，设计方案并且落地了，但是有几个问题需要处理：
    - 1. 方案涉及到四五十人的大前端各团队之间测试环境申请与部署流程的变更，我首先就得知道各团队用的是测试环境部署方案是什么，然后统一测试部署方案，沟通下来发现：
      - 有的用自动化流水线，但是流水线的方案和配置还不太一样
      - 有的用的是脚本+命令行 （知识盲区）
      - 这个简单，统一用流水线就好了，开发分支名，来作为这个环境的区分;
    - 2. 当涉及到跨子应用的开发时如何统一各子应用的测试环境呢？
      - 由于想拥有无限的测试环境，而且开发首先就得分支，想到用开发分支名，来作为这个环境的区分; （知识盲区）
    - 2. 前端部分在打包部署的时候，我需要把资源推到对应的环境上，我怎么知道当前处于哪个环境（那个分支呢）呢？
      - 打包脚本在流水线执行，可以通过在流水线（CI/CD 环境下构建）中注入环境变量，来达到下发环境变量的目的
      - 这样我在部署的时候，就以用 环境变量名，来区分环境;
  - 结果：
    - 1. 节省域名，机器资源30+
    - 2. 节省了大量新建测试环境的时间
    - 3. 解决了测试环境被不够用的问题；

- 一些可以补充说明的细节：
  - 1. 配置测试环境下webpack的publicPath（index.html中引入的<script> <link>等标签中的资源路径前缀） 以及 WebpackManifestPlugin 里生成资源清单的资源前缀
  - 2. 改写路由跳转方法，以便于每次路由跳转都能带上参数
    - 改写之前的路由跳转方法，把history 跳转方法包一层，统一用这个跳转。



- 可能设计的知识与问题：

- 1. nginx 配置
  - 参数获取： 内建变量$arg_key 的值为当前请求中 key 所对应的查询值（问号传参的key）,  key大小写不敏感
  - nginx 基础配置

```

server {
        listen       80;  # 监听端口
        server_name  localhost;  # 服务器名称或IP地址

        # 对应路径 /app1 定位到 /var/www/app1
        location /app1/ {
            alias /var/www/app1/;  # 指定 app1 的静态资源目录
            index index.html;  # 指定默认文件
            try_files $uri $uri/ /app1/index.html;  # 支持 SPA，回退到 index.html
        }

        # 对应路径 /app2 定位到 /var/www/app2
        location /app2/ {
            alias /var/www/app2/;  # 指定 app2 的静态资源目录
            index index.html;  # 指定默认文件
            try_files $uri $uri/ /app2/index.html;  # 支持 SPA，回退到 index.html
        }

        # 默认根路径，返回主站点内容
        location / {
            root /var/www/main-site;  # 主站点目录
            index index.html;  # 指定默认文件
            try_files $uri $uri/ /index.html;  # 支持 SPA，回退到 index.html
        }
    }

```


- 2. 分支名的获取
  - 项目如果是在 CI/CD 环境下构建，一般通过通过配置流水线环境变量就行了。
    - 部署时，流水线注入的，本质上是用 Node.js 的 child_process 模块中的 execSync 函数


- 3. html里资源的引用及资源清单的生成
  - 配置测试环境下webpack的publicPath（index.html中引入的<script> <link>等标签中的资源路径前缀） 以及 WebpackManifestPlugin 里生成资源清单的资源前缀


- 4. 资源清理
  - 基座部署时，触发脚本，找出项目下超过15天未更新的（项目下就是各个分支资源了） 【命令有些长，不常用也不好记，用到再查就是了】


- 3. 脚本+命令行本地部署测试环境
  - 使用pm2-deploy， 配置好起配置文件ecosystem.config.js， 然后运行npm命令， 执行 pm2 deploy ecosystem.config.js 完成部署；


- 4. 业界还有什么方案？为什么不用docker
  - 业界还可以用docker 容器做这种隔离，但是docker 对于前端来说有些重，研究docker再去做这个可能时间就会脱的比较长，毕竟docker偏向运维多一些；