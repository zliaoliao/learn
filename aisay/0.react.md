ä½ è¿™ä»½ç¬”è®°å†…å®¹éå¸¸å…¨é¢ã€æ·±å…¥ï¼Œè¦†ç›–äº†Reactçš„é«˜çº§ç‰¹æ€§ã€åŸç†ä¸é¢è¯•å¸¸è€ƒç‚¹ï¼Œä¿¡æ¯å¯†åº¦æé«˜ã€‚ä½†è¦ä¼˜åŒ–ä¸ºâ€œæçº²å¼+é«˜æ•ˆèƒŒè¯µ+çªå‡ºé‡ç‚¹+Hooksæ—¶ä»£ä¸ºä¸»â€ï¼Œç¡®å®éœ€è¦ç²¾ç®€å’Œç»“æ„å†æ¢³ç†ã€‚

æˆ‘ä¼šï¼š

1. è¡¥å……ä½ åŸç¬”è®°é—æ¼çš„å…³é”®è€ƒç‚¹ï¼›
2. å¯¹ã€Œç»„ä»¶é€šä¿¡ã€ä¸ã€ŒçŠ¶æ€ç®¡ç†ã€éƒ¨åˆ†è¿›è¡Œæç‚¼é‡æ„ï¼›
3. ç²¾ç®€ä¸ºé«˜æ•ˆèƒŒè¯µæ ¼å¼ï¼šä»¥è€ƒç‚¹ + è¦ç‚¹ + å¿«é€Ÿè®°å¿†æ³•å‘ˆç°ã€‚


### âœ… React é«˜çº§å¤ä¹ èµ„æ–™ï¼ˆæçº²å¼ Â· é¢è¯•å¯¼å‘ï¼‰

## ä¸€ã€React æ ¸å¿ƒç†å¿µä¸å‘å±•

- ğŸ§  æ ¸å¿ƒæ€æƒ³ï¼šå£°æ˜å¼ + ç»„ä»¶åŒ– + å•å‘æ•°æ®æµ
- ğŸ¯ React 18 ç‰¹æ€§ï¼š
  - å¹¶å‘æ¸²æŸ“ï¼ˆå¯ä¸­æ–­æ¸²æŸ“ï¼ŒåŸºäºFiberï¼‰
  - è‡ªåŠ¨æ‰¹å¤„ç†æ›´æ–°ï¼ˆsetTimeout/promiseä¸­ä¹Ÿæ‰¹é‡ï¼‰
    - åŒä¸€å±æ€§å¤šæ¬¡è®¾ç½®ï¼šåè€…è¦†ç›–å‰è€…
  - startTransition / useDeferredValueï¼šå®ç°ä½ä¼˜å…ˆçº§ UI æ›´æ–°


## äºŒã€ç»„ä»¶å¼€å‘ä¸é€»è¾‘å¤ç”¨

### 1. å‡½æ•°ç»„ä»¶ vs ç±»ç»„ä»¶

| ç”Ÿå‘½å‘¨æœŸ        | Hook å¯¹åº”             | è¯´æ˜                                  |
|----------------|------------------------|---------------------------------------|
| componentDidMount | `useEffect(..., [])`    | é¦–æ¬¡æŒ‚è½½                              |
| componentDidUpdate | `useEffect(..., [dep])` | ä¾èµ–å˜æ›´è§¦å‘                          |
| componentWillUnmount | `useEffect` return      | æ¸…ç†å‰¯ä½œç”¨                            |
| getDerivedStateFromProps | è®¡ç®—å±æ€§               | å¤šç”¨ `useMemo` æˆ– propsæ§åˆ¶            |
| forceUpdate    | `useReducer/flushSync` | æ‰‹åŠ¨å¼ºåˆ¶åˆ·æ–°                          |

---

### 2. ç»„ä»¶å¤ç”¨æ–¹å¼ï¼ˆé‡ç‚¹ï¼‰

| ç±»å‹             | æè¿°                                         | åœºæ™¯ç¤ºä¾‹                        |
|------------------|----------------------------------------------|----------------------------------|
| è‡ªå®šä¹‰ Hook      | å°è£…çŠ¶æ€é€»è¾‘                                 | è¡¨å•çŠ¶æ€ã€è½®è¯¢è¯·æ±‚              |
| HOCï¼ˆé«˜é˜¶ç»„ä»¶ï¼‰   | ç»„ä»¶ â†’ åŒ…è£… â†’ æ–°ç»„ä»¶                         | æƒé™æ§åˆ¶ã€æ—¥å¿—è®°å½•              |
| Render Props     | å°†æ¸²æŸ“é€»è¾‘é€šè¿‡å‡½æ•°ä¼ å…¥å­ç»„ä»¶                 | åŠ¨æ€æ¸²æŸ“åˆ—è¡¨/å¯é…ç½®è¡¨æ ¼         |
| ç»„ä»¶ç»„åˆ         | å®¹å™¨ç»„ä»¶ + å±•ç¤ºç»„ä»¶                          | è¡¨å•æ§ä»¶ã€å¸ƒå±€æŠ½è±¡              |
| æ’æ§½ï¼ˆchildrenï¼‰ | æ§åˆ¶ç»“æ„è€Œä¸æ§åˆ¶å†…å®¹                         | Modalã€Card å®¹å™¨                |
| forwardRef + useImperativeHandle | çˆ¶ç»„ä»¶è°ƒç”¨å­ç»„ä»¶æ–¹æ³•           | è¡¨å•æ ¡éªŒã€æ»šåŠ¨æ§åˆ¶              |

> â­ æ¨èé‡ç‚¹æŒæ¡ï¼šè‡ªå®šä¹‰ Hookã€forwardRefã€HOC å®æˆ˜å°è£…é€»è¾‘

---

## ä¸‰ã€Hooks æ ¸å¿ƒæœºåˆ¶

| Hook                   | åŠŸèƒ½é‡ç‚¹                                        | ä½¿ç”¨æ³¨æ„ç‚¹                                |
|------------------------|-------------------------------------------------|--------------------------------------------|
| useState               | è§¦å‘æ›´æ–°ï¼Œå€¼é—­åŒ…é™·é˜±                           | ä½¿ç”¨ setX(prev => newVal) é¿å…é—­åŒ…         |
| useEffect              | å‰¯ä½œç”¨ï¼Œå¼‚æ­¥è¯·æ±‚ã€äº‹ä»¶ç»‘å®š                     | æ¸…ç†å‰¯ä½œç”¨ï¼Œä¾èµ–é¡¹æ­£ç¡®å¡«å†™                 |
| useLayoutEffect        | åŒæ­¥æ‰§è¡Œäº DOM æ›´æ–°å‰                         | é€‚ç”¨äºç«‹å³è¯»å–/ä¿®æ”¹ DOM                   |
| useRef                 | æŒä¹…åŒ–å˜é‡ã€ä¸å¼•å‘æ›´æ–°                         | ç ´é—­åŒ…é™·é˜±ã€æ“ä½œDOMã€ç¼“å­˜å®šæ—¶å™¨           |
| useMemo / useCallback  | ä¾èµ–ç¼“å­˜                                        | ä¾èµ–ä¸å˜æ‰ç”Ÿæ•ˆï¼Œé¿å…è¿‡åº¦ä½¿ç”¨               |
| useReducer             | ä»£æ›¿ useState ç®¡ç†å¤æ‚ state é€»è¾‘              | ä¸ Context é…åˆå¯æ„å»º redux-lite æ¶æ„      |
| useContext             | è·¨å±‚ä¼ å€¼ï¼Œé…åˆ Provider                        | çŠ¶æ€å…±äº«ä½†ä¸å…·å¤‡å“åº”æ€§æ§åˆ¶ï¼ˆé€‚åˆé™æ€æ•°æ®ï¼‰|



ğŸ§© é‡ç‚¹é™·é˜±ï¼š
- çŠ¶æ€é—­åŒ…é™·é˜± â†’ ç”¨ useRef æˆ–å‡½æ•°å¼ setState
- çŠ¶æ€æ›´æ–°åç«‹å³è¯»å– â†’ ç”¨ useLayoutEffect æˆ– flushSync
- useEffect ä¾èµ–å†™é”™ â†’ æ— é™è§¦å‘ / å¤±æ•ˆ



## useReducer é…åˆ useContext

æ˜ç™½äº†ï¼Œä»¥ä¸‹æ˜¯æœ€å…³é”®çš„ **ä¸‰æ­¥ç®€åŒ–ç‰ˆ**ï¼Œå¸®åŠ©ä½ å¿«é€Ÿè®°å¿† `useReducer + useContext` çš„ä½¿ç”¨æµç¨‹ï¼š

---

### âœ… å…³é”®ä¸‰æ­¥ï¼š

1. **åˆ›å»º Context + Reducer**

   ```js
   const CounterContext = createContext();
   const reducer = (state, action) => { ... };
   ```

2. **å°è£… Provider**

   ```js
   const CounterProvider = ({ children }) => {
     const [state, dispatch] = useReducer(reducer, åˆå§‹å€¼);
     return (
       <CounterContext.Provider value={{ state, dispatch }}>
         {children}
       </CounterContext.Provider>
     );
   };
   ```

3. **å­ç»„ä»¶ä½¿ç”¨ useContext è·å– state å’Œ dispatch**

   ```js
   const { state, dispatch } = useContext(CounterContext);
   ```


## ğŸ§± React Router åŸç†ï¼ˆç®€ç‰ˆï¼‰

ä½ è¯´å¾—å¯¹ï¼Œè¿™æ®µç¡®å®è¿‡äºç®€ç•¥ï¼Œé¢è¯•æ—¶å¾ˆå¯èƒ½ä¸å¤Ÿç”¨ã€‚ä¸ºäº†åº”å¯¹é«˜çº§é¢è¯•ï¼Œå»ºè®®æ‰©å±•ä¸ºæ›´å®Œæ•´ä½†ä»ç®€æ´å¯è®°å¿†çš„ç‰ˆæœ¬ï¼š

---

## ğŸ§­ React Router æ ¸å¿ƒçŸ¥è¯†ï¼ˆé¢è¯•å¢å¼ºç‰ˆï¼‰

### âœ… 1. è·¯ç”±åŸç†

* **SPA å®ç°è·¯ç”±**ï¼šé  History API (`pushState` / `replaceState`) æˆ– hashã€‚
* **è·¯å¾„å˜æ›´ä¸ä¼šåˆ·æ–°é¡µé¢**ï¼Œä½†èƒ½è§¦å‘ç»„ä»¶æ›´æ–°ï¼ˆé ç›‘å¬ `popstate` æˆ– hashchangeï¼‰ã€‚
* **æœåŠ¡ç«¯é…ç½®**ï¼š<BrowserRouter> æ¨¡å¼ä¸‹ï¼šå¿…é¡»é…ç½® `historyApiFallback`ï¼Œå¦åˆ™åˆ·æ–°ä¼š 404ã€‚

### âœ… 2. å¸¸ç”¨ç»„ä»¶ï¼ˆv6ï¼‰

| ç»„ä»¶                | ä½œç”¨                     |
| ----------------- | ---------------------- |
| `<Link>`          | æ›¿ä»£ `<a>` å®ç°è·³è½¬          |
| `useNavigate()`   | ç¼–ç¨‹å¼è·³è½¬ï¼ˆä»£æ›¿ `useHistory`ï¼‰ |
| `useParams()`     | è·å–è·¯å¾„å‚æ•° `/user/:id`     |
| `useLocation()`   | è·å–å½“å‰è·¯ç”±ä¿¡æ¯               |

### âœ… 3. åµŒå¥—è·¯ç”± & åŠ¨æ€è·¯ç”±

* å­è·¯ç”±è¦ä½¿ç”¨ `<Outlet />` å ä½ã€‚
* åŠ¨æ€å‚æ•°ç”¨ `:param`ï¼Œé€šè¿‡ `useParams()` è·å–ã€‚

### âœ… 4. ç¼–ç¨‹å¼å¯¼èˆªä¸å®ˆå«ï¼ˆæ¨¡æ‹Ÿï¼‰

* `useNavigate()` å®ç°ç™»å½•åè·³è½¬ã€‚
* å¯åœ¨ç»„ä»¶ä¸­å†™é€»è¾‘åˆ¤æ–­ï¼ˆæ¨¡æ‹Ÿå®ˆå«ï¼‰ï¼š

  ```js
  if (!isLogin) navigate('/login');
  ```

## å››ã€çŠ¶æ€ç®¡ç†ï¼ˆHooks ä¼˜å…ˆæ–¹æ¡ˆï¼‰

### 1. ç»„ä»¶å†…çŠ¶æ€
- useState / useReducerï¼ˆå¤æ‚é€»è¾‘åœºæ™¯ï¼‰

### 2. è·¨ç»„ä»¶é€šä¿¡çŠ¶æ€

| åœºæ™¯                | æ¨èæ–¹æ¡ˆ                         |
|---------------------|----------------------------------|
| è·¨å±‚çº§ä½†éé¢‘ç¹æ›´æ–°   | useContext                       |
| å¤šç»„ä»¶é—´å…±äº«å¤æ‚é€»è¾‘ | useReducer + Context              |
| ä¸šåŠ¡ä¸­å°/å¤§å‹é¡¹ç›®     | Redux Toolkitï¼ˆç®€æ´ï¼‰æˆ– MobX      |
| çŠ¶æ€åŸå­åŒ–         | jotaiã€recoilã€zustandï¼ˆè½»é‡åŒ–ï¼‰ |

ğŸ” React 18 çŠ¶æ€ç®¡ç†é¢è¯•é‡ç‚¹ï¼š
- useReducerï¼ˆæ›¿ä»£ redux ç²¾ç®€ç‰ˆæœ¬ï¼‰
- useSyncExternalStoreï¼ˆå¹¶å‘æ¨¡å¼è®¢é˜…å®‰å…¨ï¼‰
  - useSyncExternalStore æ˜¯ React 18 å¼•å…¥çš„ä¸€ä¸ªåº•å±‚ Hookï¼Œç”¨äºè®¢é˜…å¤–éƒ¨å¯å˜æ•°æ®æºï¼Œï¼Œç¡®ä¿ç»„ä»¶åœ¨å¹¶å‘æ¸²æŸ“æ¨¡å¼ä¸‹ä¹Ÿèƒ½è·å¾—ä¸€è‡´çš„å€¼ã€‚
  - ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯ä» Reduxã€Zustand ç­‰çŠ¶æ€åº“æˆ–è‡ªå®šä¹‰ store ä¸­è®¢é˜…æ•°æ®


## äº”ã€ç»„ä»¶é€šä¿¡æ–¹å¼ï¼ˆç³»ç»ŸåŒ–ï¼‰

| é€šä¿¡æ–¹å¼            | æ–¹å‘         | åœºæ™¯                                               |
|---------------------|--------------|----------------------------------------------------|
| props        | çˆ¶ä¼ å­ / å­è°ƒçˆ¶      | æ™®é€šä¼ å‚                                           |
| ref + forwardRef     | çˆ¶è°ƒå­       | è°ƒç”¨å­ç»„ä»¶æ–¹æ³•ï¼Œé…åˆ useImperativeHandle         |
| context              | ä»»æ„å±‚çº§     | è·¨å±‚ä¼ é€’ themeã€i18n ç­‰é™æ€é…ç½®ï¼Œä¸é€‚åˆé¢‘ç¹æ›´æ–°                   |
| å…¨å±€çŠ¶æ€åº“           | ä»»æ„         | reduxã€zustandã€mobx                               |
| URL å‚æ•°             | è·¨é¡µé¢é€šä¿¡ / çŠ¶æ€æŒä¹…åŒ–         | React Routerï¼Œæ­é… useParams/useSearchParams ä½¿ç”¨ |


## å…­ã€React æ¸²æŸ“æœºåˆ¶ä¸ Fiber æ¶æ„ï¼ˆé«˜é¢‘åŸç†é¢˜ï¼‰

### æ¸²æŸ“æµç¨‹ç®€è¿°ï¼ˆv18 é»˜è®¤ Fiber æ¨¡å¼ï¼‰ï¼š

### React æ¸²æŸ“æµç¨‹ç®€è¿°ï¼ˆv18 é»˜è®¤å¯ç”¨ Fiber æ¶æ„ï¼‰

æ›´æ–°è§¦å‘ â†’ Renderï¼ˆå¯ä¸­æ–­ï¼‰â†’ Commitï¼ˆä¸å¯ä¸­æ–­ï¼‰â†’ æµè§ˆå™¨ç»˜åˆ¶

#### ğŸ§® Render é˜¶æ®µï¼ˆåˆç§°è°ƒå’Œé˜¶æ®µï¼‰ï¼š
- åˆ›å»ºæ–° Fiber æ ‘ï¼Œæ¯”è¾ƒæ–°æ—§èŠ‚ç‚¹ï¼ˆdiffï¼‰
- æ„å»º effectListï¼ˆç”Ÿå‘½å‘¨æœŸã€å‰¯ä½œç”¨ã€DOM æ“ä½œç­‰ï¼‰
- å¯ä¸­æ–­ï¼šä½¿ç”¨ `shouldYield` + `MessageChannel` æ§åˆ¶ä¼˜å…ˆçº§

#### ğŸ”§ Commit é˜¶æ®µï¼ˆçœŸæ­£æ“ä½œ DOMï¼‰ï¼š
- æ‰§è¡Œ effectList é‡Œçš„å‰¯ä½œç”¨ï¼ˆuseEffectã€DOM æ›´æ–°ã€ref ç­‰ï¼‰
- ä¸å¯ä¸­æ–­ï¼Œä¸‰é˜¶æ®µé¡ºåºï¼š
  1. **Before Mutation**
  2. **Mutation**ï¼ˆæ‰§è¡Œ DOM æ“ä½œï¼‰
  3. **Layout**ï¼ˆæ‰§è¡Œ `useLayoutEffect`ï¼‰ï¼Œæ­¤æ—¶ï¼Œæ²¡è¿›è¡Œæµè§ˆå™¨ç»˜åˆ¶ï¼ˆPaint),ä½†æ˜¯domå·²ç»æ“ä½œå®Œæˆï¼Œæ‰€ä»¥åŒæ­¥è¯»å–æœ€æ–° DOM ä¿¡æ¯ï¼ˆæ¯”å¦‚ä½ç½®ã€å°ºå¯¸ï¼Œé€‚åˆåšä¸€äº›æ ·å¼ç›¸å…³ä¼˜åŒ–å¤„ç†ï¼‰

> ğŸ§  Fiber æ˜¯é“¾å¼ç»“æ„ï¼Œæ¯ä¸ª Fiber èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå¯è°ƒåº¦çš„æœ€å°å·¥ä½œå•å…ƒï¼Œæ”¯æŒä»»åŠ¡ä¸­æ–­å’Œæ¢å¤ï¼ˆchild / sibling / returnï¼‰ã€‚


## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–é‡ç‚¹

| æŠ€æœ¯ç‚¹           | åº”ç”¨åœºæ™¯                            |
|------------------|-------------------------------------|
| React.memo       | ç»„ä»¶ props ä¸å˜æ—¶é˜»æ­¢é‡æ–°æ¸²æŸ“       |
| useMemo/useCallback | é‡å¤åˆ›å»ºå¯¹è±¡/å‡½æ•°åœºæ™¯              |
| æ‡’åŠ è½½ + Suspense | è·¯ç”±æ‡’åŠ è½½ã€å›¾ç‰‡æ‡’åŠ è½½ç­‰            |
| startTransition  | è¾“å…¥+æ¨¡ç³Šæœç´¢ç­‰ä½ä¼˜å…ˆçº§æ›´æ–°   ï¼ˆå½“å‰æ—¶é—´èŠ‚ç‚¹ä½¿ç”¨è¾ƒå°‘ï¼‰      |
| useDeferredValue | å»¶è¿Ÿå“åº” UI å±•ç¤ºå†…å®¹          ï¼ˆå½“å‰æ—¶é—´èŠ‚ç‚¹ä½¿ç”¨è¾ƒå°‘ï¼‰          |

---

- æœ‰çš„é¡¹ç›®æŠŠ Suspense å°è£…åˆ°äº† è·¯ç”±ç³»ç»Ÿã€Layoutå±‚ã€ç”šè‡³å…¨å±€ç»„ä»¶ä¸­ï¼Œæ‰€ä»¥ä½ åœ¨ä¸šåŠ¡ç»„ä»¶å±‚é¢çœ‹åˆ°çš„æ˜¯ lazy()ï¼Œä½†æ²¡çœ‹åˆ° Suspenseï¼Œå®ƒæ˜¯ï¼šè¢«å°è£…äº†ï¼è€Œä¸æ˜¯æ²¡ç”¨ï¼
- Suspense åœ¨ä¸šåŠ¡ä¸­æ›´å¤šç”¨äºç»„ä»¶æ‡’åŠ è½½ï¼Œä¸ç”¨äºè¯·æ±‚æ•°æ®ï¼›è¯·æ±‚æ•°æ®ä»ç”¨ useEffect ç­‰æ–¹å¼ç®¡ç†çŠ¶æ€ã€‚

## diff æ¯”è¾ƒ

| ç‰¹æ€§å¯¹æ¯”        | React                                  | Vue                                     |
|-----------------|-----------------------------------------|------------------------------------------|
| å¯¹æ¯”èŒƒå›´        | åŒå±‚å¯¹æ¯”ï¼Œä¸è·¨å±‚                      | åŒå±‚ä¸ºä¸»ï¼Œä¹Ÿå…è®¸ä¸€å®šå±‚çº§è°ƒæ•´ï¼ˆé€’å½’ï¼‰     |
| å­èŠ‚ç‚¹å¯¹æ¯”æ–¹å¼  | å•å‘ä»å·¦åˆ°å³ + Map ä¼˜åŒ–               | åŒç«¯æ¯”è¾ƒ + æœ€é•¿é€’å¢å­åºåˆ—ä¼˜åŒ–             |
| é‡ç‚¹ä¼˜åŒ–ç›®æ ‡    | ç²¾å‡†æ›´æ–°ï¼ˆé€šè¿‡ keyï¼‰                 | æœ€å°‘ DOM æ“ä½œï¼ˆå°½å¯èƒ½å¤ç”¨ä¸ç§»åŠ¨ï¼‰         |
| æ€§èƒ½ä¼˜åŠ£        | ç®€å•å¿«é€Ÿï¼Œé€»è¾‘æ¸…æ™°                    | æ›´å¤æ‚ï¼Œç§»åŠ¨åœºæ™¯æ€§èƒ½æ›´ä¼˜                  |
| é•¿åˆ—è¡¨é‡æ’æ•ˆç‡  | è¾ƒå·®ï¼ˆé»˜è®¤ç”¨ index ä¼šå‡ºé”™ï¼‰           | ä¼˜ç§€ï¼ˆæœ‰ key æ—¶åˆ©ç”¨ LIS å‡å°‘ç§»åŠ¨ï¼‰        |
| æ•°æ®ç»“æ„        | Fiber æ¶æ„ï¼Œæ”¯æŒå¹¶å‘æ›´æ–°              | æ ‘ç»“æ„ + patch é€’å½’                      |

React çš„ Diff æ˜¯åŸºäº Fiber æ¶æ„çš„åŒå±‚æ¯”è¾ƒç­–ç•¥ï¼Œé»˜è®¤å·¦åˆ°å³æ¯”å¯¹å­èŠ‚ç‚¹ï¼Œé€šè¿‡ key æ¥ä¼˜åŒ–èŠ‚ç‚¹å¤ç”¨ã€‚Vue çš„ Diff æ›´æ³¨é‡æœ€å°‘æ“ä½œ DOMï¼Œé‡‡ç”¨åŒç«¯æ¯”è¾ƒä¸æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•ï¼Œå¯¹é•¿åˆ—è¡¨å˜åŠ¨æœ‰æ›´å¼ºçš„ä¼˜åŒ–èƒ½åŠ›ã€‚


## å…«ã€React å¸¸è€ƒå®æˆ˜é—®é¢˜

### 1. çˆ¶ç»„ä»¶å¦‚ä½•è°ƒç”¨å­ç»„ä»¶æ–¹æ³•ï¼Ÿ
- ref + forwardRef + useImperativeHandle

### 2. å¦‚ä½•è§£å†³ useEffect ä¸­é—­åŒ…å¯¼è‡´çŠ¶æ€æ»åï¼Ÿ
- ä½¿ç”¨ useRef.current å¼•ç”¨çŠ¶æ€ï¼š `useRef().current = æœ€æ–°å€¼`
- å‡½æ•°å¼ setStateï¼š`setState((prev) => prev + 1)`
- `useEffect` ä¾èµ–æ›´æ–°

### 3. æ‰¹é‡æ›´æ–°è¡Œä¸ºï¼Ÿ
- React18 æ‰€æœ‰ setState éƒ½é»˜è®¤æ‰¹é‡åˆå¹¶ï¼ˆå¾®ä»»åŠ¡ä¸­ç»“ç®—ï¼‰

### 4. å¼‚æ­¥æ¸²æŸ“æ–¹æ¡ˆï¼ˆæ•°æ®æœªåˆ°æ—¶ä¼˜é›… fallbackï¼‰ï¼Ÿ
- Suspense + React.lazy / data-fetching

### React æ¸²æŸ“ä¸ºä»€ä¹ˆæ‹†æˆ Render + Commitï¼Ÿ
- **Render é˜¶æ®µ**ï¼šæ„é€  Fiber æ ‘ï¼Œè®¡ç®—æ›´æ–°ï¼ˆå¯ä¸­æ–­ï¼‰
- **Commit é˜¶æ®µ**ï¼šçœŸå® DOM æ“ä½œã€å‰¯ä½œç”¨å¤„ç†ï¼ˆåŒæ­¥æ‰§è¡Œï¼‰
- ä¼˜ç‚¹ï¼š
  - render é˜¶æ®µå¯ä¸­æ–­ â†’ æ›´æµç•…çš„äº¤äº’ä½“éªŒ
  - æ‹†åˆ†é¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œæé«˜å“åº”æ€§


### é—®é¢˜3ï¼šFiber æ˜¯ä»€ä¹ˆï¼Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ
- Fiber æ˜¯ä¸€ç§é“¾è¡¨ç»“æ„çš„ VDOMï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰ `child`, `sibling`, `return` ç­‰æŒ‡é’ˆï¼›
- è§£å†³ï¼š
  - åŸ VDOM æ ‘ä¸ºé€’å½’ â†’ ä¸å¯ä¸­æ–­ï¼›
  - Fiber æ”¯æŒåˆ†æ®µæ¸²æŸ“ï¼Œå¯æ¢å¤ã€ä¼˜å…ˆçº§è°ƒåº¦ã€ç²¾ç»†æ›´æ–°ã€‚
---
### ğŸ§  å…¸å‹å®æˆ˜æ¡ˆä¾‹ï¼ˆç²¾ç‚¼ä½†å®Œæ•´ï¼‰

#### âœ… æ¡ˆä¾‹ä¸€ï¼šé—­åŒ…é™·é˜±

ä»¥ä¸‹ç”¨setTimeout ä¹Ÿæ˜¯å®Œå…¨ä¸€æ ·ï¼›

1. å‡½æ•°ç ´é—­åŒ…
```jsx
import { useEffect, useState } from 'react';

function AutoIncrement() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const timer = setInterval(() => {
      setCount(prev => prev + 1); // ä½¿ç”¨å‡½æ•°å¼æ›´æ–°é¿å…é—­åŒ…é™·é˜±
    }, 1000);

    return () => clearInterval(timer); // ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
  }, []);

  return <h1>Count: {count}</h1>;
}

export default AutoIncrement;
```

2. refç ´é—­åŒ…

```jsx
import { useEffect, useRef, useState } from 'react';

function AutoIncrementWithRef() {
  const [count, setCount] = useState(0);
  const countRef = useRef(count); // åˆ›å»ºå¼•ç”¨

  // æ¯æ¬¡ count å˜åŒ–æ—¶ï¼ŒåŒæ­¥åˆ° ref
  useEffect(() => {
    countRef.current = count;
  }, [count]);

  useEffect(() => {
    const timer = setInterval(() => {
      const newCount = countRef.current + 1;
      setCount(newCount); // ç”¨æœ€æ–°å€¼æ›´æ–°çŠ¶æ€
    }, 1000);

    return () => clearInterval(timer);
  }, []);

  return <h1>Count: {count}</h1>;
}

export default AutoIncrementWithRef;
```


## âœ… çˆ¶ç»„ä»¶è°ƒç”¨å­ç»„ä»¶æ–¹æ³•ï¼ˆè¡¥å…¨è°ƒç”¨ï¼‰

ä½¿ç”¨ `forwardRef` + `useImperativeHandle`ï¼š



```tsx
// Parent.tsx
import React, { useRef } from 'react';
import Child from './Child';

export default function Parent() {
  const childRef = useRef();

  return (
    <div>
      <button onClick={() => childRef.current.add()}>å­ç»„ä»¶ +1</button>
      <button onClick={() => childRef.current.reset()}>é‡ç½®</button>
      <Child ref={childRef} />
    </div>
  );
}
```


```tsx
// Child.tsx
import React, { forwardRef, useImperativeHandle, useState } from 'react';

const Child = forwardRef((props, ref) => {
  const [count, setCount] = useState(0);

  useImperativeHandle(ref, () => ({
    add() {
      setCount(c => c + 1);
    },
    reset() {
      setCount(0);
    }
  }));

  return <div>å­ç»„ä»¶ Count: {count}</div>;
});

export default Child;
```

å½“ç„¶å¯ä»¥ï¼è¿™æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ª**æœ€ç®€ç”¨æ³•ä¾‹å­**ï¼Œå¸®åŠ©ä½ å¿«é€Ÿç†è§£ `ref + forwardRef + useImperativeHandle` çš„ç»„åˆæ˜¯å¦‚ä½•è®©**çˆ¶ç»„ä»¶è°ƒç”¨å­ç»„ä»¶æ–¹æ³•**çš„ï¼š


## ğŸ§  Zustand çŠ¶æ€ç®¡ç†ï¼šçŸ¥è¯†ç‚¹ + é¢è¯•è€ƒç‚¹

Zustand æ˜¯ä¸€ä¸ªè½»é‡çš„ React çŠ¶æ€ç®¡ç†åº“ï¼Œè®¾è®¡ç†å¿µæ˜¯ï¼š

> **ç®€æ´ã€å¼ºå¤§ã€æ—  Providerã€æ— æ ·æ¿ä»£ç ã€æ”¯æŒä¸­é—´ä»¶**

### ğŸŒŸ ä¸ºä»€ä¹ˆå—æ¬¢è¿ï¼Ÿ
- æç®€ APIï¼šåªæœ‰ `create()` å’Œ `useStore()`ï¼Œæ¯” Reduxã€MobX æ›´è½»é‡ï¼›
- æ²¡æœ‰ Providerï¼šä¸åƒ Redux éœ€è¦ `<Provider>` åŒ…è£¹ï¼›
- å¯ç»„åˆã€æ¨¡å—åŒ–ï¼šå¤©ç„¶æ”¯æŒæ¨¡å—æ‹†åˆ†ï¼›
- æ”¯æŒä¸­é—´ä»¶æ‰©å±•ï¼Œå¦‚ `persist`, `devtools`, `immer`;

### ğŸ§ª é¢è¯•é«˜é¢‘é—®é¢˜æ€»ç»“

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| Zustand å’Œ Redux æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ | Zustand ä¸éœ€è¦ Providerã€æ ·æ¿å°‘ã€å¤©ç„¶æ”¯æŒæ¨¡å—æ‹†åˆ†ã€Hook å¼è®¿é—®ï¼Œæ¯” Redux æ›´ç®€æ´ã€‚ |
| Zustand æ”¯æŒå“ªäº›ä¸­é—´ä»¶ï¼Ÿ | `persist`ï¼ˆæŒä¹…åŒ–ï¼‰ã€`devtools`ï¼ˆè°ƒè¯•å·¥å…·ï¼‰ã€`immer`ï¼ˆä¿®æ”¹åµŒå¥—å¯¹è±¡ï¼‰ã€`subscribeWithSelector`ï¼ˆä¼˜åŒ–æ¸²æŸ“ï¼‰ç­‰ |
| Zustand å¦‚ä½•æ‹†æ¨¡å—ï¼Ÿ | æ¯ä¸ª `store` ç‹¬ç«‹åˆ›å»ºï¼Œæ¨¡å—åŒ–å¯¼å‡ºï¼Œå¤©ç„¶æ”¯æŒåˆ†æ¨¡å— |
| Zustand æ”¯æŒå¼‚æ­¥è¯·æ±‚ï¼Ÿ | ç›´æ¥åœ¨ `set()` é€»è¾‘ä¸­è°ƒç”¨ `async await` |
| Zustand çŠ¶æ€æ›´æ–°æ˜¯å¦è§¦å‘æ‰€æœ‰ç»„ä»¶ï¼Ÿ | å¦ï¼Œé»˜è®¤åŸºäº selectorï¼Œåªæœ‰ä½¿ç”¨äº†å˜åŒ–å­—æ®µçš„ç»„ä»¶æ‰ä¼š re-render |


### âœ… Zustand ç®€å•ä¾‹å­ï¼ˆæ— ä¸­é—´ä»¶ï¼‰

```ts
// store/userStore.ts
import { create } from 'zustand';

const useUserStore = create((set) => ({
  user: null,
  setUser: (user) => set({ user }),
}));
```

```tsx
// Profile.tsx
import React from 'react';
import { useUserStore } from './store/userStore';

const Profile = () => {
  const user = useUserStore((state) => state.user);
  const setUser = useUserStore((state) => state.setUser);

  return (
    <div>
      <p>{user ? `Hi, ${user.name}` : 'Please login'}</p>
      <button onClick={() => setUser({ name: 'Tom' })}>Login</button>
    </div>
  );
};

export default Profile;
```

### ğŸ§  è®°å¿†è¦ç‚¹ç®€åŒ–ç‰ˆï¼š

1. `create((set) => ({ çŠ¶æ€ + æ›´æ–°æ–¹æ³• }))`
2. ç»„ä»¶ä¸­ç”¨ `useStore((state) => state.xx)` å–å€¼
  - 1. useUserStore ä¸­çš„å‚æ•°æ˜¯ä¸€ä¸ª é€‰æ‹©å™¨å‡½æ•°ï¼Œ(state) => state.user æ˜¯ä½ ä¼ å…¥çš„ selectorï¼Œè¡¨ç¤ºä½ è¦ä»å…¨å±€ store ä¸­é€‰å‡º user è¿™ä¸€éƒ¨åˆ†ï¼Œå®ƒçš„è¿”å›å€¼å°±æ˜¯ä½ ç»„ä»¶è¦ç”¨çš„æ•°æ®ã€‚ 
3. ä¿®æ”¹å€¼å°±è°ƒç”¨ `setXx(newVal)`


## âœ… æ›´æ¨èçš„ç‰ˆæœ¬ï¼ˆæ’ä»¶æ”¯æŒï¼‰

```ts
import { create } from 'zustand';
import { devtools, persist } from 'zustand/middleware';

const useUserStore = create(
  persist(
    devtools((set) => ({
      user: null,
      isLogin: false,
      setUser: (user) => set({ user, isLogin: true }),
      logout: () => set({ user: null, isLogin: false }),
    })),
    { name: 'user-storage' }
  )
);
```

```tsx
const Profile = () => {
  const { user, isLogin, setUser, logout } = useUserStore();

  return (
    <div>
      {isLogin ? (
        <>
          <p>{user?.name}</p>
          <button onClick={logout}>Logout</button>
        </>
      ) : (
        <button onClick={() => setUser({ name: 'Tom' })}>Login</button>
      )}
    </div>
  );
};
```

---

## âœ… è¿™æ ·æ›´å®¹æ˜“çªå‡ºå‡ ä¸ªé¢è¯•ç‚¹ï¼š

* Zustand çŠ¶æ€è®¾è®¡ä¸æ›´æ–°
* çŠ¶æ€é€‰æ‹© vs å…¨é‡å–å€¼çš„ä¼˜åŒ–
* çŠ¶æ€æŒä¹…åŒ– (`persist`)
* è°ƒè¯•å·¥å…·æ”¯æŒ (`devtools`)
  * devtools æ˜¯ä¸€ä¸ªå¼€å‘è°ƒè¯•æ’ä»¶ï¼Œå¯ä»¥è®©ä½ åœ¨æµè§ˆå™¨é‡Œç”¨ Redux DevTools æ’ä»¶å®æ—¶æŸ¥çœ‹ Zustand çŠ¶æ€å˜åŒ–
  * æ—¶é—´æ—…è¡Œï¼ˆå›é€€æŸæ¬¡çŠ¶æ€ï¼‰
  * { name: 'user-storage' }ï¼Œæ˜¯ åœ¨ä½¿ç”¨ä¸­é—´ä»¶ï¼ˆå¦‚ persist, devtoolsï¼‰æ—¶ä¼ çš„é…ç½®é¡¹ï¼Œç”¨æ¥æ ‡è¯†ä½ çš„ store åç§°



Zustand çœ‹ä¼¼è½»é‡ã€ç®€å•ï¼Œä½†åº•å±‚åŒæ ·åŸºäºâ€œ**å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼ˆPub-Subï¼‰**â€ï¼Œå…¶æ ¸å¿ƒå®ç°é€»è¾‘å¯ä»¥ç®€åŒ–ä¸ºï¼š

> çŠ¶æ€é›†ä¸­å­˜å‚¨ + selector ç²¾å‡†è®¢é˜… + æ¯æ¬¡ `set()` æ›´æ–°æ—¶ï¼Œé€šçŸ¥ç›¸å…³ selector è§¦å‘é‡æ–°æ¸²æŸ“ã€‚

---

## âœ… Zustand çš„æ ¸å¿ƒåŸç†ï¼ˆç®€æ˜ç‰ˆï¼‰

Zustand ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†æ„æˆï¼š

### 1. **create() åˆ›å»º store**
```ts
const store = create((set) => ({
  count: 0,
  inc: () => set((state) => ({ count: state.count + 1 }))
}));
```

å®ƒå†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ª â€œ**store çŠ¶æ€å®¹å™¨**â€ï¼Œå¹¶ä¿å­˜ï¼š
- å½“å‰ stateï¼›
- ä¸€ç»„ **listener è®¢é˜…å™¨é›†åˆ**ï¼ˆå³ï¼šè®¢é˜… state çš„ selector å‡½æ•°ï¼‰ï¼›

---

### 2. **set() æ›´æ–° state**
```ts
set(newState);
```

è°ƒç”¨ `set()` æ—¶ï¼Œzustand ä¼šï¼š
1. åˆå¹¶ `newState`ï¼›
2. éå†æ‰€æœ‰è®¢é˜…çš„ selector å‡½æ•°ï¼›
3. å¯¹æ¯”æ–°æ—§ selector ç»“æœæ˜¯å¦ç›¸ç­‰ï¼ˆæµ…æ¯”è¾ƒï¼‰ï¼›
4. å¦‚æœä¸ç›¸ç­‰ï¼Œå°±é€šçŸ¥å¯¹åº”ç»„ä»¶è§¦å‘ re-renderã€‚

âœ”ï¸ æ­£æ˜¯è¿™ç§â€œ**æŒ‰ selector ç²¾å‡†æ¯”è¾ƒå¹¶è§¦å‘ listener**â€çš„æœºåˆ¶ï¼Œä½¿å¾— Zustand çš„æ€§èƒ½éå¸¸é«˜æ•ˆï¼ˆä¸ä¼šå…¨é‡åˆ·æ–°ï¼‰ã€‚

---

### 3. **è®¢é˜…ç»„ä»¶æ—¶ç”¨ selector**
```ts
const count = useStore((state) => state.count);
```

è¿™ä¸ª selector ä¼šè¢«å­˜å‚¨åˆ° listener åˆ—è¡¨ä¸­ï¼Œå¹¶ä¸ `set()` æ—¶å¯¹æ¯”ç»“æœå˜åŒ–ä»¥åˆ¤æ–­æ˜¯å¦è§¦å‘æ›´æ–°ã€‚

---

### âœ… çŠ¶æ€è®¢é˜…æ ¸å¿ƒæœºåˆ¶ï¼ˆç®€åŒ–ç‰ˆä¼ªä»£ç ï¼‰

```ts
// å†…éƒ¨æ ¸å¿ƒç»“æ„
// ç®€åŒ–ç‰ˆ create å‡½æ•°
function create(createState) {
  let state;
  const listeners = new Set();

  const setState = (partial, replace = false) => {
    const nextState = typeof partial === 'function' ? partial(state) : partial;
    const prevState = state;
    state = replace ? nextState : { ...state, ...nextState };

    listeners.forEach((listener) => {
      const newSelected = listener.selector(state);
      if (!shallowEqual(listener.prevSelected, newSelected)) {
        listener.prevSelected = newSelected;
        listener.callback(newSelected, prevState);
      }
    });
  };

  const getState = () => state;

  const subscribe = (selector = s => s, callback) => {
    const listener = {
      selector,
      prevSelected: selector(state),
      callback,
    };
    listeners.add(listener);
    return () => listeners.delete(listener);
  };

  state = createState(setState, getState);

  return {
    getState,
    setState,
    subscribe,
  };
}


// æµ…æ¯”è¾ƒï¼ˆç”¨äº selector æ¯”è¾ƒï¼‰
function shallowEqual(a, b) {
  if (Object.is(a, b)) return true;
  if (typeof a !== 'object' || typeof b !== 'object') return false;
  if (!a || !b) return false;

  const keysA = Object.keys(a);
  const keysB = Object.keys(b);
  if (keysA.length !== keysB.length) return false;

  for (let key of keysA) {
    if (!Object.is(a[key], b[key])) return false;
  }
  return true;
}

```

---

## ğŸ§ª é¢è¯•ä¸­å¯æ€ä¹ˆè¯´ï¼Ÿï¼ˆç®€ç»ƒç‰ˆï¼‰

> Zustand å†…éƒ¨åŸºäºå‘å¸ƒ-è®¢é˜…æœºåˆ¶ï¼Œç»´æŠ¤ä¸€ä¸ªçŠ¶æ€å®¹å™¨å’Œè®¢é˜…é›†åˆã€‚æ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶ï¼Œé€šè¿‡å¯¹ selector çš„ç»“æœè¿›è¡Œæµ…æ¯”è¾ƒï¼Œåªé€šçŸ¥ä¾èµ–å˜åŒ–çš„ç»„ä»¶ï¼Œä»è€Œå®ç°ç²¾å‡†é«˜æ•ˆæ›´æ–°ã€‚ç›¸æ¯” Redux + connectï¼Œå…¨å±€æ›´æ–°è¦æ›´ç»†ç²’åº¦ï¼Œä¹Ÿæ›´æ˜“äºä½¿ç”¨ã€‚

---

## ğŸ” è¡¥å……çŸ¥è¯†ç‚¹

- çŠ¶æ€ä¸å¯å˜æ€§ç”±å¼€å‘è€…æ§åˆ¶ï¼ˆä¸å¼ºåˆ¶ï¼‰ï¼Œå¯é€šè¿‡ `immer` ä¸­é—´ä»¶ç®€åŒ–ï¼›
- `useStore(selector)` å®è´¨æ˜¯ä¸€ä¸ª `useSyncExternalStore` åŒ…è£…ï¼›
- æ”¯æŒ React 18 å¹¶å‘æ¨¡å¼ï¼ˆåŸå› æ­£æ˜¯å®ƒä½¿ç”¨äº† `useSyncExternalStore`ï¼‰ï¼›





